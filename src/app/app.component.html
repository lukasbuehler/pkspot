<!-- DEV MODE warning banner - only shows in non-production builds -->
@if(isDevMode) {
<!-- <div class="dev-mode-banner">⚠️ DEV MODE - This is NOT a production build</div> -->
} @if(!isEmbedded()) {
<!-- is not embedded  -->
<app-nav-rail-container>
  @defer (when responsive.isInitialized()) { @if(responsive.viewMode() ===
  'desktop' && !alainMode) {
  <app-nav-rail class="mat-elevation-z3">
    <a
      routerLink="/"
      class="text-decoration-none text-center text-light text-wrap p-2 logo"
    >
      <img
        ngSrc="assets/logos/pkspot/pkspot_logo_stacked_dark.png"
        alt="PK Spot"
        class="mw-100"
        width="74"
        height="48.02"
        priority
      />
    </a>
    @for (button of navbarConfig(); track $index) { @if(button.spacerBefore) {
    <div class="spacer"></div>
    } @if(button.link) {
    <a [routerLink]="button.link" tabindex="-1">
      <app-mat3-nav-button
        [icon]="button.icon"
        [label]="button.name"
      ></app-mat3-nav-button>
    </a>
    } @else {
    <app-mat3-nav-button
      [matMenuTriggerFor]="button.menu == 'user' ? userMenu : null"
      [icon]="button.icon"
      [image]="button.image ?? ''"
      [label]="button.name"
    ></app-mat3-nav-button>
    } }

    <!-- terms  -->
    <span
      class="mat-body-small d-flex align-items-center flex-row mb-0 pb-1"
      style="
        justify-content: space-evenly;
        width: 100%;
        font-size: 10px;
        color: lightgray;
      "
    >
      <a routerLink="/terms-of-service" i18n="@@terms.short">Terms</a>
      <a routerLink="/privacy-policy" i18n="@@policy.short">Policy</a>
    </span>
    <a
      routerLink="/impressum"
      class="mat-body-small mb-0 pb-1"
      style="font-size: 10px; color: lightgray"
      >Impressum</a
    >
    <span class="mat-body-small mb-0" style="font-size: 10px; color: lightgray"
      >©2026 PK Spot
    </span>
  </app-nav-rail>
  } }
  <app-nav-rail-content class="flex-col">
    <!-- This is where the pages content gets displayed -->
    <div class="main-content flex-grow-1">
      <router-outlet></router-outlet>
    </div>

    @if(alainMode) {
    <!-- Alain Mode: Menu button (shows in any view mode when alainMode is true) -->
    <button
      mat-fab
      #mainMenuTrigger="matMenuTrigger"
      [matMenuTriggerFor]="mainMenu"
      (click)="mainMenuTrigger.openMenu()"
      id="alainMenuButton"
      color="primary"
    >
      <mat-icon>menu</mat-icon>
    </button>
    <mat-menu #mainMenu="matMenu">
      @for(button of navbarConfig(); track $index) { @if(button.link) {
      <a [routerLink]="button.link">
        <button mat-menu-item>
          <mat-icon>{{ button.icon }}</mat-icon>
          <span>{{ button.name }}</span>
        </button>
      </a>
      }@else if(button.function) {
      <button mat-menu-item (click)="button.function()">
        <mat-icon>{{ button.icon }}</mat-icon>
        <span>{{ button.name }}</span>
      </button>
      } @else {
      <button
        mat-menu-item
        [matMenuTriggerFor]="button.menu == 'user' ? userMenu : null"
      >
        @if(button.image) {
        <img
          [ngSrc]="button.image"
          width="24"
          height="24"
          class="rounded-circle"
          style="margin-right: 12px"
        />
        } @else {<mat-icon>{{ button.icon }}</mat-icon>
        }
        <span>{{ button.name }}</span>
      </button>
      } }
    </mat-menu>
    } @else {
    <!-- Bottom navigation bar (only when NOT in alainMode and mobile/tablet) -->
    @defer (when responsive.isInitialized()) { @if(responsive.viewMode() ===
    'mobile' || responsive.viewMode() === 'tablet') {
    <mat-toolbar
      class="mat-elevation-z0"
      [class.native-platform]="isNativePlatform"
    >
      @for (button of navbarConfig(); track $index) { @if(button.link) {
      <a [routerLink]="button.link" tabindex="-1">
        <app-mat3-nav-button
          [icon]="button.icon"
          [label]="button.name"
        ></app-mat3-nav-button>
      </a>
      } @else if(button.function) {
      <app-mat3-nav-button
        (click)="button.function()"
        [icon]="button.icon"
        [label]="button.name"
      ></app-mat3-nav-button>
      } @else {
      <app-mat3-nav-button
        [matMenuTriggerFor]="button.menu == 'user' ? userMenu : null"
        [icon]="button.icon"
        [image]="button.image ?? ''"
        [label]="button.name"
      ></app-mat3-nav-button>
      } }
    </mat-toolbar>
    } } }

    <!-- Proactive Check-in Chip -->
    @if(checkInService.showGlobalChip() &&
    checkInService.currentProximitySpot(); as spot) {
    <div
      class="check-in-chip-container d-flex justify-content-center w-100 p-2 overflow-hidden"
      [style.bottom]="!responsive.isDesktop() ? '80px' : 'auto'"
      [style.top]="!responsive.isDesktop() ? 'auto' : '10px'"
      style="position: absolute; z-index: 1000; pointer-events: none"
      [@slideVertical]="{
        value: '*',
        params: { startPos: !responsive.isDesktop() ? '100%' : '-100%' }
      }"
    >
      <div
        class="check-in-chip mat-elevation-z4 d-flex align-items-center gap-2 px-3 py-2 rounded-pill overflow-hidden"
        (click)="router.navigate(['/map', spot.slug || spot.id])"
      >
        <mat-icon class="text-primary flex-shrink-0">place</mat-icon>
        <span
          class="mat-title-small text-truncate"
          i18n="@@checkin.at_spot_short"
          >At <strong>{{ spot.name() }}</strong> spot?</span
        >
        <button
          mat-stroked-button
          color="primary"
          style="height: 32px; line-height: 32px"
          i18n="@@checkin.check_in"
          (click)="spotCheckIn(spot.id)"
        >
          Check In
        </button>
        <button
          mat-icon-button
          class=""
          (click)="
            $event.stopPropagation(); checkInService.dismissSpot(spot.id)
          "
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    }

    <!-- Terms and Privacy -->

    @defer (when responsive.isInitialized()) { @if((!policyAccepted || !userId)
    && (responsive.viewMode() === 'mobile' || responsive.viewMode() ===
    'tablet') && !isNativePlatform) {
    <div
      class="terms-footer mat-body-small justify-content-around align-items-center flex-row mb-0 pb-1 gap-3 px-5"
      style="
        background-color: #1f1f23;
        font-size: 10px;
        color: gray;
        display: flex;
      "
    >
      <a routerLink="/terms-of-service" i18n="@@terms.short">Terms</a>
      <a routerLink="/privacy-policy" i18n="@@policy.short">Policy</a>
      <a routerLink="/impressum">Impressum</a>
      <span>©2026 PK Spot</span>
    </div>
    } }
  </app-nav-rail-content>
</app-nav-rail-container>

} @else {
<!-- is embedded -->
<div class="d-flex flex-column h-100">
  <div
    class="w-100 text-center d-flex flex-row align-items-center justify-content-between flex-shrink-1 p-3"
    style="height: 60px"
  >
    <a
      target="_blank"
      href="https://pkspot.app"
      class="text-decoration-none text-center text-light text-wrap"
      style="height: 100%; display: flex; align-items: center"
    >
      <img
        ngSrc="assets/logos/pkspot/pkspot_logo_oneline_dark.png"
        alt="PK Spot"
        style="height: 36px; width: auto; object-fit: contain"
        width="200"
        height="33.78"
        priority
      />
    </a>
    @if(responsive.isNotMobile()) {
    <a mat-stroked-button target="_blank" [href]="getUnembeddedUrl()">
      <mat-icon>open_in_new</mat-icon>
      <span i18n="@@open-embedded-in-pkspot-button-label"
        >Open this on PK Spot</span
      >
    </a>
    } @else {
    <a [href]="getUnembeddedUrl()" target="_blank" mat-mini-fab color="primary">
      <mat-icon> open_in_new </mat-icon>
    </a>
    }
  </div>
  <div class="flex-grow-1">
    <router-outlet></router-outlet>
  </div>
</div>
}

<mat-menu #userMenu="matMenu" id="userMenu">
  @for(button of (authService.isSignedIn ? authenticatedUserMenuConfig :
  unauthenticatedUserMenuConfig); track $index) { @if(button.link) {
  <a [routerLink]="button.link">
    <button mat-menu-item>
      <mat-icon>{{ button.icon }}</mat-icon>
      <span>{{ button.name }}</span>
    </button>
  </a>
  } @else if(button.function) {
  <button mat-menu-item (click)="button.function()">
    <mat-icon>{{ button.icon }}</mat-icon>
    <span>{{ button.name }}</span>
  </button>

  } @else {
  <button
    mat-menu-item
    [matMenuTriggerFor]="button.menu == 'user' ? userMenu : null"
  >
    <mat-icon>{{ button.icon }}</mat-icon>
    <span>{{ button.name }}</span>
  </button>
  } }
</mat-menu>
