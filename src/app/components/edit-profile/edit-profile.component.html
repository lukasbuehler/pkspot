<div class="d-flex flex-column gap-4">
  @if (user) {
  <!-- Cropping mode: show cropper after image is selected -->
  @if (newProfilePictureSrc && !croppingComplete) {
  <app-crop-image
    class="mb-4"
    [imageSource]="newProfilePictureSrc"
    (imageCropped)="onImageCropped($event)"
    (cancelled)="cancelProfilePictureUpload()"
  ></app-crop-image>
  } @else {
  <!-- Normal mode: show upload and current picture -->
  <div
    class="rounded border p-3 mt-3 mb-4 d-flex flex-column align-items-center"
  >
    @if (user.profilePicture) {
    <div class="text-center position-relative">
      <div class="d-inline-block position-relative">
        <img
          class="profile-picture"
          [src]="tempProfilePictureSrc || user.profilePicture.getSrc(200)"
          (error)="hasProfilePictureError = true; isProfilePictureLoaded = true"
          (load)="isProfilePictureLoaded = true; hasProfilePictureError = false"
          [style.opacity]="
            isProfilePictureLoaded && !hasProfilePictureError ? 1 : 0
          "
          priority
        />

        <!-- Loading / Saving Overlay -->
        @if (!isProfilePictureLoaded || isUpdatingProfilePicture) {
        <div
          class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
          style="background: rgba(0, 0, 0, 0.3); border-radius: 50%"
        >
          <mat-spinner diameter="40" color="accent"></mat-spinner>
        </div>
        } @if (hasProfilePictureError && !isUpdatingProfilePicture) {
        <div class="position-absolute top-50 start-50 translate-middle">
          <mat-icon class="text-muted" style="transform: scale(2)"
            >image_not_supported</mat-icon
          >
        </div>
        }
      </div>
      <h5
        class="mat-body mt-3 mb-4"
        i18n="
          current profile picture|Label for current profile
          picture@@editProfile.currentPicture"
      >
        Your current profile picture
      </h5>
    </div>
    }
    <div class="w-100">
      <input
        #profilePictureInput
        hidden="true"
        type="file"
        accept="image/png,image/jpeg,image/jpg"
        (change)="onProfilePictureFileSelected($event)"
      />
      <button
        mat-stroked-button
        class="w-100"
        (click)="profilePictureInput.click()"
        [disabled]="isUpdatingProfilePicture"
        i18n="
          select profile picture button|Button to select profile
          picture@@editProfile.selectPicture"
      >
        <mat-icon>image</mat-icon>
        Select Profile Picture
      </button>
    </div>
  </div>
  }

  <mat-form-field
    appearance="outline"
    matBadge="&#8288;"
    matBadgeColor="accent"
    [matBadgeHidden]="displayName === user.displayName"
    matBadgeSize="small"
    subscriptSizing="dynamic"
  >
    <mat-label
      i18n="
        display name label|Label for display name field@@editProfile.displayName"
      >Display Name</mat-label
    >
    <input
      matInput
      type="text"
      [value]="displayName"
      (input)="
        displayName = getValueFromEventTarget($event.target) ?? '';
        detectIfChanges()
      "
    />
  </mat-form-field>

  <mat-form-field
    appearance="outline"
    matBadge="&#8288;"
    matBadgeColor="accent"
    [matBadgeHidden]="biography === user.biography"
    matBadgeSize="small"
    subscriptSizing="dynamic"
  >
    <mat-label
      i18n="biography label|Label for biography field@@editProfile.biography"
      >Biography</mat-label
    >
    <textarea
      matInput
      placeholder="Write your Bio here..."
      [value]="biography"
      (input)="
        biography = getValueFromEventTarget($event.target) ?? '';
        detectIfChanges()
      "
      i18n-placeholder="
        biography placeholder|Placeholder text for
        biography@@editProfile.biographyPlaceholder"
    ></textarea>
  </mat-form-field>

  <mat-form-field
    appearance="outline"
    matBadge="&#8288;"
    matBadgeColor="accent"
    [matBadgeHidden]="nationalityCode === user.nationalityCode"
    matBadgeSize="small"
    subscriptSizing="dynamic"
  >
    <mat-label i18n="nationality code label@@editProfile.nationalityCode"
      >Nationality</mat-label
    >
    <input
      matInput
      type="text"
      placeholder="e.g. Germany"
      [formControl]="countryControl"
      [matAutocomplete]="auto"
    />
    <mat-autocomplete #auto="matAutocomplete">
      <mat-option
        *ngFor="let code of filteredCountries | async"
        [value]="countries[code].name"
      >
        <span>{{ countries[code].emoji }} {{ countries[code].name }}</span>
      </mat-option>
    </mat-autocomplete>
    <!-- <mat-hint i18n="nationality code hint@@editProfile.nationalityCodeHint"
      >Select your nationality.</mat-hint
    > -->
  </mat-form-field>

  <mat-form-field
    appearance="outline"
    matBadge="&#8288;"
    matBadgeColor="accent"
    [matBadgeHidden]="homeCity === user.homeCity"
    matBadgeSize="small"
    subscriptSizing="dynamic"
  >
    <mat-label i18n="home city label@@editProfile.homeCity"
      >Home City</mat-label
    >
    <input
      matInput
      type="text"
      [value]="homeCity"
      (input)="
        homeCity = getValueFromEventTarget($event.target) ?? '';
        detectIfChanges()
      "
    />
  </mat-form-field>

  <div class="mb-3">
    <h3 class="mat-title-small mb-2">
      <ng-container i18n="home spots label@@editProfile.homeSpots"
        >Home Spots</ng-container
      >
      ({{ homeSpots.length }}/3)
    </h3>
    <app-search-field
      appearance="outline"
      [onlySpots]="true"
      (spotSelected)="onSpotSelected($event)"
    ></app-search-field>

    <div class="d-flex flex-column gap-2 mt-3">
      @for (spot of homeSpotsObjects; track spot.id) {
      <div class="d-flex gap-2 align-items-center">
        <app-spot-preview-card
          [spotData]="spot"
          [imgSize]="200"
          [showInfoButton]="false"
          class="flex-grow-1"
        ></app-spot-preview-card>
        <button mat-icon-button color="warn" (click)="removeHomeSpot(spot.id)">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
      }
    </div>
  </div>

  <mat-form-field
    appearance="outline"
    matBadge="&#8288;"
    matBadgeColor="accent"
    [matBadgeHidden]="startDate === user.startDate"
    matBadgeSize="small"
    subscriptSizing="dynamic"
  >
    <mat-label
      i18n="start date label|Label for start date field@@editProfile.startDate"
      >Start Date</mat-label
    >
    <input
      matInput
      [matDatepicker]="picker"
      [(ngModel)]="startDate"
      (dateChange)="startDate = $event.value; detectIfChanges()"
    />
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
    <mat-hint
      i18n="start date hint|Hint text for start date@@editProfile.startDateHint"
      >This is the date you started practicing Parkour and Freerunning. It will
      be rounded to full years after one year or more so don't sweat
      it.</mat-hint
    >
  </mat-form-field>
  } @else {
  <div class="d-flex justify-content-center w-100 p-5">
    <mat-spinner color="accent"></mat-spinner>
  </div>
  }
</div>
