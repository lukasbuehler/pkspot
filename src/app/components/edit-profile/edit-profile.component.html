<div class="d-flex flex-column">
  @if (user) {
  <!-- Cropping mode: show cropper after image is selected -->
  @if (newProfilePictureSrc && !croppingComplete) {
  <app-crop-image
    class="mb-4"
    [imageSource]="newProfilePictureSrc"
    (imageCropped)="onImageCropped($event)"
    (cancelled)="cancelProfilePictureUpload()"
  ></app-crop-image>
  } @else {
  <!-- Normal mode: show upload and current picture -->
  <div
    matBadge="&#8288;"
    matBadgeColor="accent"
    [matBadgeHidden]="!croppedProfilePicture"
    matBadgeSize="small"
    class="rounded border p-3 mt-3 mb-4 d-flex flex-column align-items-center"
  >
    @if (user.profilePicture && !croppedProfilePicture) {
    <div class="text-center">
      <img class="profile-picture" [src]="user.profilePicture.getSrc(200)" />
      <h5
        class="mat-body mt-3 mb-4"
        i18n="
          current profile picture|Label for current profile
          picture@@editProfile.currentPicture"
      >
        Your current profile picture
      </h5>
    </div>
    } @if (croppedProfilePicture) {
    <div class="text-center">
      <img class="profile-picture" [src]="croppedProfilePicture" />
      <h5
        class="mat-body mt-3 mb-2"
        i18n="
          cropped profile picture|Label for cropped profile
          picture@@editProfile.croppedPicture"
      >
        Your cropped profile picture
      </h5>
      <p
        class="mat-caption text-muted"
        i18n="ready to upload|Status message@@editProfile.readyToUpload"
      >
        Ready to upload
      </p>
    </div>
    }
    <div class="w-100">
      <input
        #profilePictureInput
        hidden="true"
        type="file"
        accept="image/png,image/jpeg,image/jpg"
        (change)="onProfilePictureFileSelected($event)"
      />
      <button
        mat-stroked-button
        class="w-100"
        (click)="profilePictureInput.click()"
        i18n="
          select profile picture button|Button to select profile
          picture@@editProfile.selectPicture"
      >
        <mat-icon>image</mat-icon>
        Select Profile Picture
      </button>
    </div>
    @if (croppedProfilePicture) {
    <button
      mat-flat-button
      color="accent"
      class="mt-3 w-100"
      (click)="saveNewProfilePicture()"
      [disabled]="isUpdatingProfilePicture"
      i18n="
        upload and save button|Button to upload and save profile
        picture@@editProfile.uploadAndSave"
    >
      Upload and save
    </button>
    }
  </div>
  }

  <mat-form-field
    appearance="outline"
    matBadge="&#8288;"
    matBadgeColor="accent"
    [matBadgeHidden]="displayName === user.displayName"
    matBadgeSize="small"
  >
    <mat-label
      i18n="
        display name label|Label for display name field@@editProfile.displayName"
      >Display Name</mat-label
    >
    <input
      matInput
      type="text"
      [value]="displayName"
      (input)="
        displayName = getValueFromEventTarget($event.target) ?? '';
        detectIfChanges()
      "
    />
  </mat-form-field>

  <mat-form-field
    appearance="outline"
    matBadge="&#8288;"
    matBadgeColor="accent"
    [matBadgeHidden]="biography === user.biography"
    matBadgeSize="small"
  >
    <mat-label
      i18n="biography label|Label for biography field@@editProfile.biography"
      >Biography</mat-label
    >
    <textarea
      matInput
      placeholder="Write your Bio here..."
      [value]="biography"
      (input)="
        biography = getValueFromEventTarget($event.target) ?? '';
        detectIfChanges()
      "
      i18n-placeholder="
        biography placeholder|Placeholder text for
        biography@@editProfile.biographyPlaceholder"
    ></textarea>
  </mat-form-field>

  <mat-form-field
    appearance="outline"
    matBadge="&#8288;"
    matBadgeColor="accent"
    [matBadgeHidden]="startDate === user.startDate"
    matBadgeSize="small"
  >
    <mat-label
      i18n="start date label|Label for start date field@@editProfile.startDate"
      >Start Date</mat-label
    >
    <input
      matInput
      [matDatepicker]="picker"
      [value]="startDate"
      (dateChange)="startDate = $event.target.value; detectIfChanges()"
    />
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
    <mat-hint
      i18n="start date hint|Hint text for start date@@editProfile.startDateHint"
      >This is the date you started practicing Parkour and Freerunning. It will
      be rounded to full years after one year or more so don't sweat
      it.</mat-hint
    >
  </mat-form-field>
  } @else {
  <div class="d-flex justify-content-center w-100 p-5">
    <mat-spinner color="accent"></mat-spinner>
  </div>
  }
</div>
