<div class="settings-page-container">
  <div class="container p-4">
    <div class="row">
      <div class="col-md-4">
        <div class="menu d-flex flex-column rounded border mb-5">
          @for(menuPoint of menuPoints; track $index) {
          <button
            mat-button
            (click)="openMenuPoint(menuPoint.id)"
            class="menuButton"
            [ngClass]="menuPoint.id === selectedPoint ? 'selected' : ''"
          >
            <mat-icon
              matBadge="&#8288;"
              [matBadgeHidden]="!menuPoint.hasChanges"
              matBadgeColor="accent"
              [matBadgeOverlap]="true"
              matBadgePosition="before"
              matBadgeSize="small"
              aria-hidden="false"
              >{{ menuPoint.icon }}</mat-icon
            >
            <span>{{ menuPoint.name }}</span>
          </button>
          }
        </div>
      </div>
      <div [ngSwitch]="selectedPoint" class="col-md-8">
        <h1
          class="mat-h1 mb-2"
          i18n="settings page title|Title of the settings page@@settings.title"
        >
          Settings
        </h1>
        <mat-divider class="mb-3"></mat-divider>
        <div [hidden]="selectedPoint !== 'profile'">
          <!-- Basic profile properties -->
          <h2
            class="mat-h2"
            i18n="
              public profile section|Header for public profile
              section@@settings.profile.header"
          >
            Public profile
          </h2>
          <span
            class="mat-body"
            i18n="
              public profile description|Description of public profile
              section@@settings.profile.description"
          >
            You can edit your public profile here. The information on your
            public profile can be seen by everyone, even unauthenticated
            visitors.
          </span>

          <app-edit-profile
            #editProfileComponent
            class="mt-4"
            (changes)="profileHasChanges($event)"
          ></app-edit-profile>
        </div>
        <div *ngSwitchCase="'account'">
          <h2
            class="mat-h2"
            i18n="account section header@@settings.account.header"
          >
            Account
          </h2>
          <p
            class="mat-body"
            i18n="account section description@@settings.account.description"
          >
            Manage your account settings including email, password, and account
            deletion.
          </p>

          <!-- Email Section -->
          <div class="my-4 p-3 rounded border">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3 class="mat-h3 m-0" i18n>E-Mail address</h3>
              @if(!isEmailExpanded && !isOAuthUser) {
              <button
                mat-button
                color="primary"
                (click)="isEmailExpanded = true"
                i18n
              >
                Edit
              </button>
              }
            </div>

            @if(!isEmailExpanded) {
            <div class="d-flex align-items-center gap-2">
              <span class="mat-body-strong">{{ emailAddress }}</span>
              @if(authService.user?.emailVerified) {
              <mat-icon
                i18n-matTooltip
                matTooltip="Verified"
                class="text-success"
                style="font-size: 20px; height: 20px; width: 20px"
                >verified</mat-icon
              >
              } @else {
              <mat-icon
                i18n-matTooltip
                matTooltip="Not verified"
                color="warn"
                style="font-size: 20px; height: 20px; width: 20px"
                >warning</mat-icon
              >
              <button
                mat-button
                color="accent"
                (click)="verifyUserEmailAddress()"
                i18n
              >
                Verify now
              </button>
              }
            </div>
            } @else {
            <div class="d-flex flex-column gap-3">
              <mat-form-field appearance="outline">
                <mat-label i18n>Current E-mail</mat-label>
                <input matInput type="email" [value]="emailAddress" disabled />
                @if(!authService.user?.emailVerified) {
                <mat-icon
                  matSuffix
                  i18n-matTooltip
                  matTooltip="Not verified"
                  color="warn"
                  >warning</mat-icon
                >
                } @else {
                <mat-icon
                  matSuffix
                  i18n-matTooltip
                  matTooltip="Verified"
                  class="text-success"
                  >verified</mat-icon
                >
                }
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label i18n>New E-mail address</mat-label>
                <input matInput type="email" [(ngModel)]="newEmailAddress" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label i18n>Current password (for confirmation)</mat-label>
                <input
                  matInput
                  type="password"
                  [(ngModel)]="emailChangePassword"
                />
              </mat-form-field>
              <div class="d-flex gap-2">
                <button
                  mat-stroked-button
                  (click)="isEmailExpanded = false"
                  i18n
                >
                  Cancel
                </button>
                <button
                  mat-flat-button
                  color="primary"
                  [disabled]="
                    isChangingEmail || !newEmailAddress || !emailChangePassword
                  "
                  (click)="changeEmailAddress()"
                >
                  @if(isChangingEmail) {
                  <mat-spinner diameter="20" strokeWidth="2"></mat-spinner>
                  } @else {
                  <span i18n>Change E-mail address</span>
                  }
                </button>
              </div>
            </div>
            }
          </div>

          <!-- Password Section -->
          @if(!isOAuthUser) {
          <div class="my-4 p-3 rounded border">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3 class="mat-h3 m-0" i18n>Password</h3>
              @if(!isPasswordExpanded) {
              <button
                mat-button
                color="primary"
                (click)="isPasswordExpanded = true"
                i18n
              >
                Edit
              </button>
              }
            </div>

            @if(!isPasswordExpanded) {
            <div class="d-flex align-items-center gap-2">
              <span class="mat-body fw-bold">•••••••••••••</span>
            </div>
            } @else {
            <div class="d-flex flex-column gap-3">
              <mat-form-field appearance="outline">
                <mat-label i18n>Current password</mat-label>
                <input matInput type="password" [(ngModel)]="currentPassword" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label i18n>New password</mat-label>
                <input matInput type="password" [(ngModel)]="newPassword" />
                <mat-hint i18n>Minimum 6 characters</mat-hint>
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label i18n>Confirm new password</mat-label>
                <input
                  matInput
                  type="password"
                  [(ngModel)]="confirmNewPassword"
                />
              </mat-form-field>
              <div class="d-flex gap-2">
                <button
                  mat-stroked-button
                  (click)="isPasswordExpanded = false"
                  i18n
                >
                  Cancel
                </button>
                <button
                  mat-flat-button
                  color="primary"
                  [disabled]="
                    isChangingPassword ||
                    !currentPassword ||
                    !newPassword ||
                    !confirmNewPassword
                  "
                  (click)="changePassword()"
                >
                  @if(isChangingPassword) {
                  <mat-spinner diameter="20" strokeWidth="2"></mat-spinner>
                  } @else {
                  <span i18n>Change password</span>
                  }
                </button>
              </div>
            </div>
            }
          </div>
          }

          <!-- Delete Account Section -->
          <div class="my-4 p-3 rounded border border-danger">
            <h3 class="mat-h3 text-danger" i18n>Delete Account</h3>
            <p class="mat-body" i18n>
              Permanently delete your account and all associated data. This
              action cannot be undone.
            </p>

            @if(!showDeleteConfirmation) {
            <button
              mat-stroked-button
              color="warn"
              (click)="confirmDeleteAccount()"
              i18n
            >
              Delete my account
            </button>
            } @else {
            <div
              class="d-flex flex-column gap-3 mt-3 p-3 rounded"
              style="background: rgba(var(--mat-warn-color), 0.1)"
            >
              @if(isOAuthUser) {
              <p class="mat-body-strong text-danger" i18n>
                Are you sure? You will need to sign in with
                {{ providerDisplayName }} again to confirm deletion.
              </p>
              } @else {
              <p class="mat-body-strong text-danger" i18n>
                Are you sure? Enter your password to confirm deletion.
              </p>
              <mat-form-field appearance="outline">
                <mat-label i18n>Password</mat-label>
                <input
                  matInput
                  type="password"
                  [(ngModel)]="deleteAccountPassword"
                />
              </mat-form-field>
              }

              <div class="d-flex gap-2">
                <button mat-stroked-button (click)="cancelDeleteAccount()" i18n>
                  Cancel
                </button>
                <button
                  mat-flat-button
                  color="warn"
                  [disabled]="
                    isDeletingAccount ||
                    (!isOAuthUser && !deleteAccountPassword)
                  "
                  (click)="deleteAccount()"
                >
                  @if(isDeletingAccount) {
                  <mat-spinner diameter="20" strokeWidth="2"></mat-spinner>
                  } @else {
                  <span i18n>Permanently delete</span>
                  }
                </button>
              </div>
            </div>
            }
          </div>
        </div>
        <!-- <div *ngSwitchCase="'general'">
          <h2 class="mat-h2" i18n>General settings</h2>
          <h3 class="mat-body" i18n>
            General settings to tune your experience on PK Spot.
          </h3>
          <div class="my-4">
            <h3 class="mat-h3">Geo-URI links</h3>
            <p class="mat-body">
              On supported mobile devices this will open the spot location in
              the preferred native maps app. This is enabled by default for the
              best experience.
            </p>
            <mat-checkbox [checked]="authService?.user?.settings?.useGeoURI !== false"
              >Use Geo-URI to open maps on mobile devices</mat-checkbox
            >
          </div>
          <div class="my-4">
            <h3 class="mat-h3">Preferred external maps application</h3>
            <p class="mat-body">
              This selection will be used if Geo-URI is not supported or
              disabled above.
            </p>
            <mat-button-toggle-group name="fontStyle" [value]="authService?.user?.settings?.maps || 'googlemaps'">
              <mat-button-toggle value="googlemaps"
                >Google Maps</mat-button-toggle
              >
              <mat-button-toggle value="applemaps"
                >Apple Maps</mat-button-toggle
              >
              <mat-button-toggle value="openstreetmap"
                >OpenSreetMap</mat-button-toggle
              >
            </mat-button-toggle-group>
          </div> 
        </div>
        <div *ngSwitchCase="'notifications'">
          <h2 class="mat-h2" i18n>Notifications</h2>
        </div>-->
      </div>
    </div>
  </div>
</div>
@if(hasChanges) {
<app-speed-dial-fab
  #saveSpeedDial
  id="saveSpeedDial"
  [buttonConfig]="speedDialButtonConfig"
  [openOnHover]="true"
  [rotationDegrees]="0"
  (mainFabClick)="saveAllChanges()"
  (miniFabClick)="miniFabPressed()"
></app-speed-dial-fab>
}
