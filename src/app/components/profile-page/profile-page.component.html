<div class="profile-page">
  @if (isLoading) {
  <div class="profile-state" aria-live="polite">
    <mat-spinner
      diameter="48"
      strokeWidth="4"
      aria-label="Loading profile"
    ></mat-spinner>
  </div>
  } @else { @if (user) {
  <div class="profile-grid">
    @if(isBlocked) {
    <div
      class="profile-blocked-container d-flex flex-column align-items-center justify-content-center p-5 text-center w-100"
      style="min-height: 50vh"
    >
      <mat-icon
        class="icon-size-large mb-3 text-muted"
        style="transform: scale(3); margin-bottom: 2rem !important"
        >block</mat-icon
      >
      <h2 class="mat-headline-medium mb-2 mt-4">You have blocked this user</h2>
      <p class="mat-body-large text-muted mb-4">
        Unblock them to see their profile and posts.
      </p>
      <button mat-stroked-button color="warn" (click)="toggleBlockUser()">
        Unblock User
      </button>
    </div>
    } @else {
    <section class="profile-primary" aria-label="Profile overview">
      <mat-card class="profile-overview__card mat-elevation-z1">
        <mat-card-content>
          <div class="profile-overview__content position-relative">
            @if (profilePicture) {
            <div class="profile-overview__avatar">
              <img
                [ngSrc]="profilePicture"
                [alt]="
                  user.displayName
                    ? user.displayName + ' profile picture'
                    : 'Profile picture'
                "
                fill
              />
            </div>
            } @else {
            <div
              class="profile-overview__avatar profile-overview__avatar--placeholder mat-display-small flex-shrink-0"
              aria-hidden="true"
            >
              {{ user.displayName ? user.displayName.charAt(0) : "?" }}
            </div>
            }

            <div class="profile-overview__details">
              <div class="profile-overview__heading">
                <span class="mat-headline-small profile-overview__name mb-0">
                  {{ user.displayName }}
                </span>
                <mat-chip-set aria-label="Profile status">
                  @if (isMyProfile) {
                  <mat-chip color="primary" class="mat-label-large"
                    >You</mat-chip
                  >
                  }
                </mat-chip-set>
              </div>
              @if (user.biography) {
              <span class="mat-body-large">
                {{ user.biography }}
              </span>
              }
              <div class="d-flex flex-column gap-1">
                @if (user.nationalityCode || user.homeCity) {
                <div
                  class="mat-body-large profile-overview__location d-flex align-items-center"
                >
                  <mat-icon class="m-1 icon-size-small">location_on</mat-icon>

                  @if(user.homeCity) {
                  <span i18n>In</span>&nbsp;<strong>{{ user.homeCity }}</strong>
                  } @if(user.homeCity && user.nationalityCode)
                  {<span>,&nbsp;</span>} @if(user.nationalityCode &&
                  countries[user.nationalityCode]) {
                  <span i18n>from</span>&nbsp;<strong>{{
                    countries[user.nationalityCode].name
                  }}</strong
                  >&nbsp;{{ countries[user.nationalityCode].emoji }}
                  }
                </div>
                } @if (user.startTimeDiffString) {
                <div
                  class="mat-body-large profile-overview__tenure d-flex align-items-center"
                >
                  <mat-icon class="m-1 icon-size-small">history</mat-icon>
                  <span i18n>Freerunner since</span>&nbsp;
                  <strong>{{ user.startTimeDiffString }}</strong>
                </div>
                }
              </div>

              <div class="d-flex justify-content-around text-center py-2">
                <div
                  class="d-flex flex-column clickable-stat p-2 rounded"
                  matRipple
                  (click)="viewFollowers()"
                >
                  <span class="mat-headline-medium mb-0">
                    <app-fancy-counter
                      [number]="user.followerCount || 0"
                    ></app-fancy-counter>
                  </span>
                  <span class="mat-body-small text-muted" i18n
                    >{user.followerCount, plural, =1 {Follower} other
                    {Followers}}</span
                  >
                </div>
                <div
                  class="d-flex flex-column clickable-stat p-2 rounded"
                  matRipple
                  (click)="viewFollowing()"
                >
                  <span class="mat-headline-medium mb-0">
                    <app-fancy-counter
                      [number]="followingCount || 0"
                    ></app-fancy-counter>
                  </span>
                  <span class="mat-body-small text-muted" i18n>Following</span>
                </div>
              </div>

              @if (!isMyProfile) {
              <div
                class="profile-overview__actions w-100 d-flex gap-2"
                aria-label="Profile actions"
              >
                <button
                  [matButton]="isFollowing ? 'outlined' : 'filled'"
                  color="primary"
                  class="profile-overview__action flex-grow-1"
                  (click)="followButtonClick()"
                >
                  @if (loadingFollowing) {
                  <mat-spinner
                    diameter="20"
                    strokeWidth="3"
                    class="profile-overview__action-spinner"
                    aria-label="Updating follow status"
                  ></mat-spinner>
                  } @if(isFollowing) {
                  <span i18n>Unfollow</span>
                  } @else {
                  <span i18n>Follow</span>
                  }
                </button>
                <!-- <button
                  mat-stroked-button
                  color="primary"
                  class="profile-overview__action"
                >
                  Contact
                </button> -->
                <button
                  mat-stroked-button
                  color="warn"
                  class="profile-overview__action flex-grow-1"
                  (click)="toggleBlockUser()"
                >
                  {{ isBlocked ? "Unblock" : "Block" }}
                </button>
              </div>
              } @else {
              <div
                class="profile-overview__actions w-100 d-flex gap-2"
                aria-label="Profile management actions"
              >
                <button
                  matButton="filled"
                  color="primary"
                  class="profile-overview__action flex-grow-1"
                  routerLink="/settings/general"
                >
                  Settings
                </button>
                <button
                  mat-stroked-button
                  color="accent"
                  class="profile-overview__action flex-grow-1"
                  routerLink="/settings/profile"
                >
                  Edit Profile
                </button>
              </div>
              }
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- saved and visited spots -->
      @if (isMyProfile) {
      <mat-card class="profile-section mat-elevation-z1">
        <mat-card-header class="profile-section__header d-flex flex-column">
          <mat-card-title class="mat-title-small" i18n>
            Your Private Spot Lists
          </mat-card-title>
          <p class="mat-body-small text-muted m-0" i18n>Only visible to you.</p>
        </mat-card-header>
        <mat-card-content class="profile-section__content">
          @if(privateDataLoading) {
          <div class="private-spot-loading">
            <mat-spinner diameter="28" strokeWidth="3"></mat-spinner>
          </div>
          }

          <div class="private-spot-actions">
            <button
              mat-stroked-button
              color="primary"
              (click)="openPrivateSpotListsDialog('saved')"
              [disabled]="privateDataLoading"
              class="private-spot-action"
            >
              <mat-icon>bookmark</mat-icon>
              <span i18n>Saved Spots</span>
              <span class="private-spot-count">
                ({{ savedSpotIds.length }})</span
              >
            </button>

            <button
              mat-stroked-button
              color="accent"
              (click)="openPrivateSpotListsDialog('visited')"
              [disabled]="privateDataLoading"
              class="private-spot-action"
            >
              <mat-icon>beenhere</mat-icon>
              <span i18n>Visited Spots</span>
              <span class="private-spot-count">
                ({{ visitedSpotIds.length }})</span
              >
            </button>
          </div>
        </mat-card-content>
      </mat-card>
      }

      <!-- homespots -->
      @if(homeSpotsObjects.length > 0) {
      <mat-card>
        <mat-card-header class="profile-section__header">
          <mat-card-title
            class="mat-title-small d-flex align-items-center gap-3"
            ><span i18n>Home Spots</span> @if(isMyProfile) {
            <span class="mat-body-small border rounded p-1" i18n>Public</span>
            }</mat-card-title
          >
        </mat-card-header>
        <mat-card-content class="profile-section__content home-spots-container">
          @for (spot of homeSpotsObjects; track spot.id) {
          <a
            [routerLink]="['/s', spot.slug ?? spot.id]"
            style="text-decoration: none; color: inherit"
          >
            <app-spot-preview-card
              [spotData]="spot"
              [imgSize]="200"
              [clickable]="true"
            ></app-spot-preview-card
          ></a>
          }
        </mat-card-content>
      </mat-card>
      }
      <!-- 
      <mat-card class="profile-section mat-elevation-z1">
        <mat-card-header class="profile-section__header">
          <mat-card-title class="mat-title-small">Posts</mat-card-title>
        </mat-card-header>
        <mat-card-content class="profile-section__content">
          <p class="mat-body-medium profile-section__placeholder">
            Posts from {{ user.displayName || "this athlete" }} will appear here
            soon.
          </p>
        </mat-card-content>
      </mat-card> -->
    </section>

    <section class="profile-secondary" aria-label="Additional profile details">
      @if (badges.length > 0) {
      <mat-card>
        <mat-card-header class="profile-section__header">
          <mat-card-title i18n class="mat-title-small">Badges</mat-card-title>
        </mat-card-header>
        <mat-card-content class="profile-section__content">
          <div class="badge-grid">
            @for (badge of badges; track badge.id) {
            <div
              class="badge-item"
              [title]="badge.name"
              [matTooltip]="badge.name + ' (Level ' + badge.tier + ')'"
            >
              <img [src]="badge.icon" [alt]="badge.name" class="badge-icon" />
              <span class="badge-name mat-body-small">{{ badge.name }}</span>
            </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
      }

      <mat-card class="profile-section mat-elevation-z1">
        <mat-card-header
          class="profile-section__header d-flex flex-row align-items-center justify-content-between pb-2"
        >
          <mat-card-title class="mat-title-small m-0" i18n
            >Contributions</mat-card-title
          ><a
            [routerLink]="['/leaderboard']"
            matButton="outlined"
            color="primary"
          >
            <mat-icon>leaderboard</mat-icon><span i18n>Leaderboard</span>
          </a>
        </mat-card-header>
        <mat-card-content
          class="profile-section__content d-flex flex-column gap-2"
        >
          <div class="d-flex flex-row justify-content-around text-center py-2">
            <div class="d-flex flex-column px-1">
              <span class="mat-headline-medium mb-0">{{
                createdSpotsCount
              }}</span>
              <span class="mat-body-small text-muted" i18n>Spots Created</span>
            </div>
            <div class="d-flex flex-column px-1">
              <span class="mat-headline-medium mb-0">{{
                editedSpotsCount
              }}</span>
              <span class="mat-body-small text-muted" i18n>Edits Made</span>
            </div>
            <div class="d-flex flex-column px-1">
              <span class="mat-headline-medium mb-0">{{
                mediaAddedCount
              }}</span>
              <span class="mat-body-small text-muted" i18n>Media Added</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </section>
    }
  </div>
  } @else {
  <div class="profile-state" aria-live="polite">
    <p class="mat-body-medium">This user does not exist!</p>
  </div>
  } }
</div>
