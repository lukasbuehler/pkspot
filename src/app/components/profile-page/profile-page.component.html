<div class="profile-page">
  @if (isLoading) {
  <div class="profile-state" aria-live="polite">
    <mat-spinner
      diameter="48"
      strokeWidth="4"
      aria-label="Loading profile"
    ></mat-spinner>
  </div>
  } @else { @if (user) {
  <div class="profile-grid">
    <section class="profile-primary" aria-label="Profile overview">
      <mat-card class="profile-overview__card mat-elevation-z1">
        <mat-card-content>
          <div class="profile-overview__content">
            @if (profilePicture) {
            <img
              class="profile-overview__avatar"
              [src]="profilePicture"
              [alt]="
                user.displayName
                  ? user.displayName + ' profile picture'
                  : 'Profile picture'
              "
            />
            } @else {
            <div
              class="profile-overview__avatar profile-overview__avatar--placeholder mat-display-small flex-shrink-0"
              aria-hidden="true"
            >
              {{ user.displayName ? user.displayName.charAt(0) : "?" }}
            </div>
            }

            <div class="profile-overview__details">
              <div class="profile-overview__heading">
                <span class="mat-headline-small profile-overview__name mb-0">
                  {{ user.displayName }}
                </span>
                <mat-chip-set aria-label="Profile status">
                  @if (isMyProfile) {
                  <mat-chip color="primary" class="mat-label-large"
                    >You</mat-chip
                  >
                  }
                </mat-chip-set>
              </div>
              @if (user.biography) {
              <span class="mat-body-large">
                {{ user.biography }}
              </span>
              }
              <div class="d-flex flex-column gap-1">
                @if (user.nationalityCode || user.homeCity) {
                <div
                  class="mat-body-large profile-overview__location d-flex align-items-center"
                >
                  <mat-icon class="m-1 icon-size-small">location_on</mat-icon>

                  @if(user.homeCity) {
                  <span i18n>In</span>&nbsp;<strong>{{ user.homeCity }}</strong>
                  } @if(user.homeCity && user.nationalityCode)
                  {<span>,&nbsp;</span>} @if(user.nationalityCode &&
                  countries[user.nationalityCode]) {
                  <span i18n>from</span>&nbsp;<strong>{{
                    countries[user.nationalityCode].name
                  }}</strong>
                  {{ countries[user.nationalityCode].emoji }}
                  }
                </div>
                } @if (user.startTimeDiffString) {
                <div
                  class="mat-body-large profile-overview__tenure d-flex align-items-center"
                >
                  <mat-icon class="m-1 icon-size-small">history</mat-icon>
                  <span i18n>Freerunner since</span>&nbsp;
                  <strong>{{ user.startTimeDiffString }}</strong>
                </div>
                }
              </div>

              <div class="d-flex justify-content-around text-center py-2">
                <div
                  class="d-flex flex-column clickable-stat p-2 rounded"
                  matRipple
                  (click)="viewFollowers()"
                >
                  <span class="mat-headline-medium mb-0">
                    <app-fancy-counter
                      [number]="user.followerCount || 0"
                    ></app-fancy-counter>
                  </span>
                  <span class="mat-body-small text-muted" i18n
                    >{user.followerCount, plural, =1 {Follower} other
                    {Followers}}</span
                  >
                </div>
                <div
                  class="d-flex flex-column clickable-stat p-2 rounded"
                  matRipple
                  (click)="viewFollowing()"
                >
                  <span class="mat-headline-medium mb-0">
                    <app-fancy-counter
                      [number]="followingCount || 0"
                    ></app-fancy-counter>
                  </span>
                  <span class="mat-body-small text-muted" i18n>Following</span>
                </div>
              </div>

              @if (!isMyProfile) {
              <div
                class="profile-overview__actions w-100 d-flex gap-2"
                aria-label="Profile actions"
              >
                <button
                  [matButton]="isFollowing ? 'outlined' : 'filled'"
                  color="primary"
                  class="profile-overview__action flex-grow-1"
                  (click)="followButtonClick()"
                >
                  @if (loadingFollowing) {
                  <mat-spinner
                    diameter="20"
                    strokeWidth="3"
                    class="profile-overview__action-spinner"
                    aria-label="Updating follow status"
                  ></mat-spinner>
                  } @if(isFollowing) {
                  <span i18n>Unfollow</span>
                  } @else {
                  <span i18n>Follow</span>
                  }
                </button>
                <!-- <button
                  mat-stroked-button
                  color="primary"
                  class="profile-overview__action"
                >
                  Contact
                </button> -->
                <button
                  mat-stroked-button
                  color="warn"
                  class="profile-overview__action flex-grow-1"
                >
                  Block
                </button>
              </div>
              } @else {
              <div
                class="profile-overview__actions w-100"
                aria-label="Profile management actions"
              >
                <button
                  mat-stroked-button
                  color="accent"
                  class="profile-overview__action w-100"
                  routerLink="/settings/profile"
                >
                  Edit Profile
                </button>
              </div>
              }
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- homespots -->
      @if(homeSpotsObjects.length > 0) {
      <mat-card>
        <mat-card-header class="profile-section__header">
          <mat-card-title class="mat-title-small" i18n
            >Home Spots</mat-card-title
          >
        </mat-card-header>
        <mat-card-content class="profile-section__content home-spots-container">
          @for (spot of homeSpotsObjects; track spot.id) {
          <a
            [routerLink]="['/s', spot.slug ?? spot.id]"
            style="text-decoration: none; color: inherit"
          >
            <app-spot-preview-card
              [spotData]="spot"
              [imgSize]="200"
              [clickable]="true"
            ></app-spot-preview-card
          ></a>
          }
        </mat-card-content>
      </mat-card>
      }
      <!-- 
      <mat-card class="profile-section mat-elevation-z1">
        <mat-card-header class="profile-section__header">
          <mat-card-title class="mat-title-small">Posts</mat-card-title>
        </mat-card-header>
        <mat-card-content class="profile-section__content">
          <p class="mat-body-medium profile-section__placeholder">
            Posts from {{ user.displayName || "this athlete" }} will appear here
            soon.
          </p>
        </mat-card-content>
      </mat-card> -->
    </section>

    <section class="profile-secondary" aria-label="Additional profile details">
      <mat-card class="profile-section mat-elevation-z1">
        <mat-card-header class="profile-section__header">
          <mat-card-title class="mat-title-small" i18n
            >Contributions</mat-card-title
          >
        </mat-card-header>
        <mat-card-content class="profile-section__content">
          <div class="d-flex justify-content-around text-center py-2">
            <div class="d-flex flex-column">
              <span class="mat-headline-medium mb-0">{{
                createdSpotsCount
              }}</span>
              <span class="mat-body-small text-muted" i18n>Spots Created</span>
            </div>
            <div class="d-flex flex-column">
              <span class="mat-headline-medium mb-0">{{
                editedSpotsCount
              }}</span>
              <span class="mat-body-small text-muted" i18n>Edits Made</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header class="profile-section__header">
          <mat-card-title i18n class="mat-title-small">Badges</mat-card-title>
        </mat-card-header>
        <mat-card-content class="profile-section__content">
          <div class="d-flex flex-column gap-2">
            @for (badge of badges; track badge.id) { } @empty {
            <p class="mat-body-medium text-muted">
              {{ user.displayName || "this athlete" }}
              <span i18n>has no badges yet!</span>
            </p>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </section>
  </div>
  } @else {
  <div class="profile-state" aria-live="polite">
    <p class="mat-body-medium">This user does not exist!</p>
  </div>
  } }
</div>
