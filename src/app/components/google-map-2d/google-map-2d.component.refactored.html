@if(mapsApiService.isApiLoaded()) {
<google-map
  #googleMap
  id="googleMap"
  [center]="center"
  [zoom]="_zoom()"
  [options]="mapOptions"
  [mapTypeId]="mapTypeId()"
  (mapClick)="mapClick.emit()"
  (boundsChanged)="boundsChanged()"
  (centerChanged)="centerChanged()"
  (zoomChanged)="getAndEmitChangedZoom()"
  width="100%"
  height="100%"
>
  @if(isDebug()) {
  <!-- Debug rectangles for each tile -->
  @for(tile of visibleTiles()?.tiles; track $index) {
  <map-rectangle
    [bounds]="getBoundsForTile({ zoom: visibleTiles()!.zoom, x: tile.x, y: tile.y })"
    [options]="{
      strokeColor: '#FF0000',
      strokeOpacity: 0.7,
      strokeWeight: 1,
      fillOpacity: 0
    }"
  ></map-rectangle>
  }

  <!-- Debug: Rendering bounds -->
  <map-rectangle
    [bounds]="boundsToRender()!"
    [options]="{
      strokeColor: '#FF0000',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillOpacity: 0
    }"
  ></map-rectangle>

  <!-- Debug zoom level -->
  <div
    style="
      color: white;
      background-color: red;
      position: absolute;
      bottom: 20px;
      right: 20px;
      padding: 10px;
    "
  >
    Debug Mode: Zoom {{ zoom }}, Visible Markers: {{ visibleMarkers().length }}
  </div>
  }

  <!-- NEW: Render all markers using the unified marker renderer -->
  @for (marker of visibleMarkers(); track $index) {
  <app-map-marker-renderer
    [marker]="marker"
    [zoom]="_zoom()"
    [isDarkMode]="isDarkMode()"
    (markerClick)="onMarkerClick({marker: marker, index: $index})"
    (markerDragEnd)="onMarkerDragEnd($event)"
  ></app-map-marker-renderer>
  }

  <!-- Regular spot display (only when zoom >= 16 and not using marker manager) -->
  @if (zoom >= 16 && spots.length > 0) { @for(spot of spots; track $index) {
  @if(!spot?.hasBounds()) {
  <map-circle
    [center]="spot.location()"
    [radius]="10"
    [options]="spotCircleDarkOptions"
    (circleClick)="spotClick.emit(spot)"
  ></map-circle>
  } @else { @if(!(isSelectedSpotBeingEdited(spot)) && spot.paths &&
  spot.paths.length > 0 && spot.paths[0] && spot.paths[0].length > 0) {
  <map-polygon
    [options]="spotPolygonDarkOptions"
    [paths]="spot.paths[0]"
    (polygonClick)="spotClick.emit(spot)"
  ></map-polygon>
  } } } }

  <!-- Selected spot polygon (for editing) -->
  @if(showSelectedSpotPolygon() && isEditing()) {
  <map-polygon
    #selectedSpotPolygon
    [key]="selectedSpotKey() + '-' + polygonRecreationKey()"
    [options]="selectedSpotPolygonEditingOptions"
    [paths]="selectedSpotFirstPath()"
    (polygonChanged)="updateSelectedSpotPaths(getPathFromPolygon($event.polygon))"
  ></map-polygon>
  }

  <!-- Selected spot challenges -->
  @if(selectedSpot() && selectedSpotChallenges().length > 0) { @for(challenge of
  selectedSpotChallenges(); track $index) { @if(challenge.location) {
  <map-advanced-marker
    [position]="challenge.location"
    [content]="challengeDot"
    [zIndex]="10"
  ></map-advanced-marker>
  <div
    #challengeDot
    class="small-dot-marker"
    [ngClass]="{
            'marker-primary-dark': isDarkMode(),
            'marker-primary-light': !isDarkMode()
          }"
    style="height: 15px; width: 15px"
  ></div>
  } } }

  <!-- Geolocation marker -->
  @if(showGeolocation && geolocation()) {
  <div #geolocationMarker class="geolocation-marker"></div>
  <map-advanced-marker
    [position]="geolocation()!.location"
    [content]="geolocationMarker"
    [zIndex]="1000000"
  ></map-advanced-marker>
  <map-circle
    [center]="geolocation()!.location"
    [radius]="geolocation()!.accuracy"
    [options]="geolocationCircleOptions"
  ></map-circle>
  }

  <!-- Additional Polygons -->
  @for(polygon of polygons(); track $index) {
  <map-polygon
    [paths]="polygon.paths"
    [options]="{
        strokeColor: polygon.strokeColor || '#FF0000',
        strokeOpacity: polygon.strokeOpacity || 0.8,
        strokeWeight: polygon.strokeWeight || 2,
        fillColor: polygon.fillColor || '#FF0000',
        fillOpacity: polygon.fillOpacity || 0.35
      }"
  ></map-polygon>
  }
</google-map>
}
